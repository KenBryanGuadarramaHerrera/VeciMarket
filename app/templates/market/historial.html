{% extends "base.html" %}
{% block content %}

<style>
    .history-header {
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Estilo de Tabla Moderna */
    .history-table { width: 100%; border-collapse: collapse; }
    
    .history-table th { 
        text-align: left; padding: 1.2rem; 
        color: var(--text-light); font-size: 0.9rem; 
        border-bottom: 2px solid #eee; font-weight: 600;
    }
    
    .history-table td { 
        padding: 1.2rem; border-bottom: 1px solid #f5f5f5; 
        vertical-align: middle; color: var(--text);
    }
    
    .history-table tr:last-child td { border-bottom: none; }
    .history-table tr:hover td { background-color: #fafafa; }

    /* Badges de Estado (Chips) */
    .status-chip {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 6px 12px; border-radius: 20px;
        font-size: 0.85rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    
    .st-success { background: #E3F9E5; color: #1F4D25; } /* Entregado */
    .st-warning { background: #FFF4E5; color: #663C00; } /* Pendiente/Buscando */
    .st-info    { background: #E5F6FF; color: #004085; } /* En Camino/Recoger */

    /* Miniaturas de productos */
    .order-thumbs { display: flex; gap: -10px; }
    .thumb-img {
        width: 40px; height: 40px; border-radius: 50%;
        border: 2px solid white; object-fit: cover;
        background: #eee;
    }
    .more-items {
        width: 40px; height: 40px; border-radius: 50%;
        background: #f0f0f0; color: var(--text-light);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: 700; border: 2px solid white;
    }

    /* Bot√≥n de volver a pedir (simulado) */
    .btn-reorder {
        color: var(--primary); text-decoration: none; font-weight: 700; font-size: 0.9rem;
    }
    .btn-reorder:hover { text-decoration: underline; }
</style>

<div class="history-header">
    <div>
        <h2 style="color: var(--dark); margin-bottom: 0.2rem;">üìú Mis Pedidos</h2>
        <p style="color: var(--text-light);">Historial de tus compras recientes</p>
    </div>
    <a href="{{ url_for('market.catalogo') }}" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem; text-decoration: none;">
        üõçÔ∏è Seguir Comprando
    </a>
</div>

<div class="card" style="padding: 0; overflow: hidden;">
    {% if pedidos %}
    <div style="overflow-x: auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Tienda(s)</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Entrega</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pedidos %}
                <tr>
                    <td>
                        <strong style="color: var(--dark);">#{{ p.id }}</strong><br>
                        <small style="color: var(--text-light);">{{ p.fecha.strftime('%d/%m/%Y') }}</small>
                    </td>

                    <td>
                        <div class="order-thumbs">
                            {% for item in p.items[:3] %}
                            <img src="{{ url_for('static', filename='uploads/' + item.producto.imagen) }}" 
                                 class="thumb-img" title="{{ item.producto.nombre }}">
                            {% endfor %}
                            
                            {% if p.items|length > 3 %}
                            <div class="more-items">+{{ p.items|length - 3 }}</div>
                            {% endif %}
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-light);">
                            üè™ {{ p.items[0].producto.propietario.nombre }} {% if p.items|length > 1 %} y otros...{% endif %}
                        </div>
                    </td>

                    <td>
                        <span style="font-size: 1.1rem; font-weight: 700; color: var(--dark);">${{ p.total }}</span><br>
                        <small style="color: var(--text-light);">{{ p.metodo_pago }}</small>
                    </td>

                    <td>
                        {% if p.estado == 'entregado' %}
                            <span class="status-chip st-success">‚úÖ Entregado</span>
                        {% elif p.estado == 'en_camino' %}
                            <span class="status-chip st-info">üöÄ En Camino</span>
                        {% else %}
                            {% if p.tipo_entrega == 'recoger' %}
                                <span class="status-chip st-info">üõçÔ∏è Listo p/ Recoger</span>
                            {% else %}
                                <span class="status-chip st-warning">üïí Buscando Repartidor</span>
                            {% endif %}
                        {% endif %}
                    </td>

                    <td>
                        {% if p.tipo_entrega == 'recoger' %}
                            <span style="font-size: 0.9rem;">üè™ Recoger</span>
                        {% else %}
                            <span style="font-size: 0.9rem;">üõµ Env√≠o</span>
                        {% endif %}
                    </td>

                    <td>
                         <a href="#" class="btn-reorder" onclick="alert('Detalle del pedido #{{ p.id }}\n\nProductos:\n{% for i in p.items %}- {{ i.producto.nombre }} (${{ i.producto.precio }})\n{% endfor %}\nTotal: ${{ p.total }}'); return false;">
                            Ver Ticket
                         </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üßæ</div>
        <h3 style="color: var(--text-light);">No tienes pedidos a√∫n</h3>
        <p style="margin-bottom: 2rem; color: var(--text-light);">Tus compras pasadas aparecer√°n aqu√≠.</p>
        <a href="{{ url_for('market.catalogo') }}" class="btn-primary" style="display: inline-block; width: auto;">
            Ir a comprar
        </a>
    </div>
    {% endif %}
</div>

{% endblock %}